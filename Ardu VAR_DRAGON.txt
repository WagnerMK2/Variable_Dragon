# Variable_Dragon 9-12-20
# exhaust cut out control system with arduino
#
#
# sensing engine run = batt voltage
#	less than 13.19 = engine off
#	equal or more than 13.2 engine on
#
# Battery volage = sould be able to use a microcontroller to get this.
#
#
# current sensor = senses motor over run.
#	need to find nominal plate moving current. some microcontroller have an internal shunt and maybe we can make a 
#	custom shunt circuit?
#
# MAP sensor = GM 2 BAR style
#	need a sensor conversion chart and graph?
#	
# LEDS
#	one for open
#	one for closed
#	blinking for in motion
#
# Motor control board.
#	motor control board should have 4 relays for basic DC motor control. possibly with second pair of close relays that provide
#	a lower voltage close comand that is used in the OFF mode closed maintainance. lower voltage path would be attained by a 
#	voltage divider circuit.
#	
#	
#
# mode switch
#	ON/OFF/AUTO = mode will be dictated by a 3 way switch and two digital inputs with OFF providing no voltage input
#					this will provide safety in mode selection?
#   
#	ON = opens valve in a loop that checks mode status change
#		starts with checking status of valve then opens if closed then checks for mode change
#
#	OFF = checks valve status then closes if indicated open. 
#		if indicated closed tries small blip of voltage to close valve and checks against the running amperage
#		  
#	AUTO = opens and closes valve based on batt voltage, accesory indiccation, and MAP sensor input.
#		checks against is motor running, and engine load. two separate open/close variables create an open/close hysterisys.
#		
#	Notes: every loop should have a mode check	
#	
#

VOID INIT #startup

ClTime = closing timer count timer should equal average close time plus a half second.
	overamp should shut this off before timer ends.
CLcounter = closing counter variable initialize
OFFcounter = OFF mode counter
OFFtimerthres = time threshold till close attempt
maint timer = off maintainance close timer
	this could be full or half voltage command
Z = throttle close threshold
E = throttle open threshold
open_status = TRUE/FALSE #is valve open
AmpOver = amperage threshold that signals a motor over run
assign digital input pin to auto mode
assign digital input pin to on mode
assign digital output pin to open valve command #one pin commands two relays... use intermediate transister to handle load and voltage isolation
assign digital output pin to close valve command #one pin commands two relays... use intermediate transister to handle load and voltage isolation
assign analog input pin to amp current sensor input = current_read 
assign analog input pin to voltage sensing input 


check mode

if mode ON 
	open valve
	goto ON loop
if mode OFF
	close valve
	goto OFF loop
if mode AUTO 
	close valve
	goto AUTO loop


VOID loop

# OFF loop
OFFMODE:
#	while off = TRUE
	if open status = true;
		digitalWrite(CLOSE,HIGH)
		# amerage overload loop
			while CLcounter <= ClTime
				if read current_read >= AmpOver 
					digitalWrite(close, HIGH)
				else 
					Delay(50)
					increment CLtimer
		digitalWrite(close,LOW)
		CLcounter = 0  #reset counter
		GOTO OFFMODE:
	else; #status closed
		if mode != OFF
			check mode
			GOTO appropriate mode
		else   #timer count up till close command
			while OFFcounter <= OFFtimerthres	
						
						
						
						
				while closed
					if check mode
						goto mode
					else 
						
















































